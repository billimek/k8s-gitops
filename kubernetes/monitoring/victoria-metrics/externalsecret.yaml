---
# yaml-language-server: $schema=https://crd.movishell.pl/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: victoriametrics
  namespace: monitoring
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: victoria-metrics-k8s-stack-helm-values
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        values.yaml: |
          alertmanager:
            config:
              global:
                slack_api_url: "{{ .DISCORD_ALERTMANAGER_WEBHOOK_URL }}"
              receivers:
                - name: 'blackhole'
                - name: 'critical-slack'
                  slack_configs:
                    - channel: '#prometheus'
                      icon_url: https://avatars3.githubusercontent.com/u/3380462
                      username: 'Alertmanager'
                      send_resolved: true
                      title: "[{{ "{{" }} .Status | toUpper {{ "}}" }}{{ "{{" }} if eq .Status \"firing\" {{ "}}" }}:{{ "{{" }} .Alerts.Firing | len {{ "}}" }}{{ "{{" }} end {{ "}}" }}] {{ "{{" }} if eq .Status \"firing\" {{ "}}" }}üî•{{ "{{" }} else {{ "}}" }}‚úÖ{{ "{{" }} end {{ "}}" }} {{ "{{" }} if ne .CommonAnnotations.summary \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.summary {{ "}}" }} {{ "{{" }} else if ne .CommonAnnotations.message \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.message {{ "}}" }} {{ "{{" }} else if ne .CommonAnnotations.description \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.description {{ "}}" }} {{ "{{" }} else {{ "}}" }}{{ "{{" }} .CommonLabels.alertname {{ "}}" }}{{ "{{" }} end {{ "}}" }}"
                      text: "{{ "{{" }} range .Alerts -{{ "}}" }}\n**{{ "{{" }} .Annotations.title {{ "}}" }}** - `{{ "{{" }} .Labels.severity {{ "}}" }}`\n{{ "{{" }} if ne .Annotations.summary \"\" {{ "}}" }}{{ "{{" }} .Annotations.summary {{ "}}" }}{{ "{{" }} else if ne .Annotations.description \"\" {{ "}}" }}{{ "{{" }} .Annotations.description {{ "}}" }}{{ "{{" }} end {{ "}}" }}\n\nüè∑Ô∏è `{{ "{{" }} .Labels.alertname {{ "}}" }}`{{ "{{" }} if .Labels.namespace {{ "}}" }} | ns:`{{ "{{" }} .Labels.namespace {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.instance {{ "}}" }} | `{{ "{{" }} .Labels.instance {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.job {{ "}}" }} | job:`{{ "{{" }} .Labels.job {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.pod {{ "}}" }} | pod:`{{ "{{" }} .Labels.pod {{ "}}" }}`{{ "{{" }} end {{ "}}" }}\n{{ "{{" }} end {{ "}}" }}"
                - name: 'warning-slack'
                  slack_configs:
                    - api_url: "{{ .DISCORD_ALERTMANAGER_WEBHOOK_URL_WARNING }}"
                      channel: '#prom-warning'
                      icon_url: https://avatars3.githubusercontent.com/u/3380462
                      username: 'Alertmanager'
                      send_resolved: true
                      title: "[{{ "{{" }} .Status | toUpper {{ "}}" }}{{ "{{" }} if eq .Status \"firing\" {{ "}}" }}:{{ "{{" }} .Alerts.Firing | len {{ "}}" }}{{ "{{" }} end {{ "}}" }}] {{ "{{" }} if eq .Status \"firing\" {{ "}}" }}‚ö†Ô∏è{{ "{{" }} else {{ "}}" }}‚úÖ{{ "{{" }} end {{ "}}" }} {{ "{{" }} if ne .CommonAnnotations.summary \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.summary {{ "}}" }} {{ "{{" }} else if ne .CommonAnnotations.message \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.message {{ "}}" }} {{ "{{" }} else if ne .CommonAnnotations.description \"\" {{ "}}" }}{{ "{{" }} .CommonAnnotations.description {{ "}}" }} {{ "{{" }} else {{ "}}" }}{{ "{{" }} .CommonLabels.alertname {{ "}}" }}{{ "{{" }} end {{ "}}" }}"
                      text: "{{ "{{" }} range .Alerts -{{ "}}" }}\n**{{ "{{" }} .Annotations.title {{ "}}" }}** - `{{ "{{" }} .Labels.severity {{ "}}" }}`\n{{ "{{" }} if ne .Annotations.summary \"\" {{ "}}" }}{{ "{{" }} .Annotations.summary {{ "}}" }}{{ "{{" }} else if ne .Annotations.description \"\" {{ "}}" }}{{ "{{" }} .Annotations.description {{ "}}" }}{{ "{{" }} end {{ "}}" }}\n\nüè∑Ô∏è `{{ "{{" }} .Labels.alertname {{ "}}" }}`{{ "{{" }} if .Labels.namespace {{ "}}" }} | ns:`{{ "{{" }} .Labels.namespace {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.instance {{ "}}" }} | `{{ "{{" }} .Labels.instance {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.job {{ "}}" }} | job:`{{ "{{" }} .Labels.job {{ "}}" }}`{{ "{{" }} end {{ "}}" }}{{ "{{" }} if .Labels.pod {{ "}}" }} | pod:`{{ "{{" }} .Labels.pod {{ "}}" }}`{{ "{{" }} end {{ "}}" }}\n{{ "{{" }} end {{ "}}" }}"
        additionalScrapeConfigs.yaml: |
          - job_name: 'home-assistant'
            scrape_interval: 60s
            metrics_path: '/api/prometheus'
            authorization:
              credentials: "{{ .PROM_HASS_TOKEN }}"
            scheme: http
            static_configs:
            - targets:
              - home-assistant.default.svc:8123
  dataFrom:
    - extract:
        key: prometheus
