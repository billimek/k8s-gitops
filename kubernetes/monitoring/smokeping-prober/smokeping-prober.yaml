---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v4.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app smokeping-prober
  namespace: monitoring
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      smokeping-prober:
        containers:
          app:
            image:
              repository: quay.io/superq/smokeping-prober
              tag: v0.10.0@sha256:3717411629519de66c7b4ff767f61766c71b8d0d3a80707ae4c970d4e47f6cf6
            env:
              GOMAXPROCS: "1"
            args:
              - --config.file=/config/smokeping.yaml
              - --web.listen-address=:9374
            securityContext:
              # ICMP requires CAP_NET_RAW capability
              # Must run as root for raw socket access
              runAsUser: 0
              runAsNonRoot: false
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities:
                add: ["NET_RAW"]
                drop: ["ALL"]
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                memory: 128Mi
          # Sidecar that monitors gateway ICMP responses and triggers a pod restart
          # if the gateway is reachable but smokeping's raw socket has become stuck.
          # Logic: if 10.0.7.1 requests are incrementing but responses are frozen
          # for two consecutive 30s checks (~60s), the liveness probe fails and
          # Kubernetes restarts the pod. If the gateway itself is unreachable
          # (router reboot), both counters stall and no restart is triggered.
          healthcheck:
            image:
              repository: busybox
              tag: 1.37.0@sha256:b3255e7dfbcd10cb367af0d409747d511aeb66dfac98cf30e97e87e4207dd76f
            command:
              - /bin/sh
              - -c
              - |
                METRICS_URL="http://localhost:9374/metrics"
                HEALTHY_FILE="/tmp/smokeping-healthy"
                prev_responses=""
                touch "$HEALTHY_FILE"
                while true; do
                  sleep 30
                  requests=$(wget -qO- "$METRICS_URL" 2>/dev/null \
                    | grep 'smokeping_requests_total{host="10.0.7.1"' \
                    | awk '{print $2}')
                  responses=$(wget -qO- "$METRICS_URL" 2>/dev/null \
                    | grep 'smokeping_response_duration_seconds_count{host="10.0.7.1"' \
                    | awk '{print $2}')
                  # If we can't scrape metrics at all, stay healthy (avoid restart loop)
                  if [ -z "$requests" ] || [ -z "$responses" ]; then
                    touch "$HEALTHY_FILE"
                    prev_responses=""
                    continue
                  fi
                  # If gateway requests are flowing but responses are frozen vs last check,
                  # the raw ICMP socket is stuck - mark unhealthy to trigger pod restart.
                  # If prev_responses is empty (first run), just record and continue.
                  if [ -n "$prev_responses" ] && [ "$requests" != "$responses" ] && [ "$responses" = "$prev_responses" ]; then
                    rm -f "$HEALTHY_FILE"
                  else
                    touch "$HEALTHY_FILE"
                  fi
                  prev_responses="$responses"
                done
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command: ["test", "-f", "/tmp/smokeping-healthy"]
                  initialDelaySeconds: 90
                  periodSeconds: 30
                  failureThreshold: 3
                  successThreshold: 1
                  timeoutSeconds: 5
            securityContext:
              runAsUser: 1000
              runAsNonRoot: true
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
            resources:
              requests:
                cpu: 5m
                memory: 8Mi
              limits:
                memory: 32Mi
    
    service:
      app:
        controller: smokeping-prober
        ipFamilyPolicy: SingleStack
        ports:
          metrics:
            port: 9374
    
    configMaps:
      config:
        data:
          smokeping.yaml: |
            targets:
              # Local gateway - used as health signal by the sidecar healthcheck
              - hosts:
                  - 10.0.7.1             # OPNsense gateway
                interval: 1s
                network: ip4
                protocol: icmp
                size: 56
              
              # Public DNS Servers (IPv4)
              - hosts:
                  - 1.1.1.1              # Cloudflare Primary
                  - 1.0.0.1              # Cloudflare Secondary
                  - 8.8.8.8              # Google Primary
                  - 8.8.4.4              # Google Secondary
                  - 9.9.9.9              # Quad9 Primary
                  # 149.112.112.112 is used for WAN2 gateway monitoring in OPNsense
                interval: 1s
                network: ip4
                protocol: icmp
                size: 56
              
              # Internet Services
              - hosts:
                  - google.com
                  - github.com
                  - cnn.com
                  - ghcr.io
                interval: 1s
                network: ip4
                protocol: icmp
                size: 56
    
    persistence:
      config:
        type: configMap
        name: smokeping-prober
        globalMounts:
          - path: /config
            readOnly: true
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
