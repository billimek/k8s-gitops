---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gateway-api-rules
  namespace: monitoring
spec:
  groups:
    - name: gateway-api.rules
      rules:
        - alert: GatewayDown
          expr: gateway_api_gateway_status{type="Accepted"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: Gateway {{ $labels.name }} is not accepting traffic
            description: "Gateway {{ $labels.name }} in namespace {{ $labels.namespace }} has not been accepting traffic for 5 minutes\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

        - alert: HTTPRouteNotAccepted
          expr: gateway_api_httproute_status{type="Accepted"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: HTTPRoute {{ $labels.name }} is not accepted
            description: "HTTPRoute {{ $labels.name }} in namespace {{ $labels.namespace }} is not accepted by its parent Gateway\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

        - alert: EnvoyProxyDown
          expr: up{job="cilium-envoy"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: Envoy proxy instance is down
            description: "Envoy proxy instance {{ $labels.instance }} has been down for 2 minutes\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

        - alert: EnvoyHighResponseTime
          expr: histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket[5m])) by (le, envoy_cluster_name)) > 3000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Envoy proxy high response time
            description: "Envoy cluster {{ $labels.envoy_cluster_name }} p99 response time is above 3 seconds\n  VALUE = {{ $value }}ms\n  LABELS = {{ $labels }}"

        - alert: EnvoyHighErrorRate
          expr: sum(rate(envoy_cluster_upstream_rq{envoy_response_code=~"5.."}[5m])) by (envoy_cluster_name) / sum(rate(envoy_cluster_upstream_rq[5m])) by (envoy_cluster_name) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: Envoy proxy high error rate
            description: "Envoy cluster {{ $labels.envoy_cluster_name }} error rate is above 5%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
