---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-event-exporter
  namespace: monitoring
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      kubernetes-event-exporter:
        serviceAccount:
          name: kubernetes-event-exporter
        containers:
          app:
            image:
              repository: ghcr.io/resmoio/kubernetes-event-exporter
              tag: v1.7@sha256:8abb52b66557d3333f9e473e0eff2951309abfd018bd8d7fcfd86c4ecce6b9cf
            args:
              - -conf=/config/config.yaml
            env:
              DISCORD_WEBHOOK_URL:
                secretKeyRef:
                  name: kubernetes-event-exporter-secret
                  key: webhook-url
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: &metricsPort 2112
                  initialDelaySeconds: 10
                  periodSeconds: 30
                  timeoutSeconds: 3
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: *metricsPort
                  initialDelaySeconds: 5
                  periodSeconds: 30
                  timeoutSeconds: 3
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                memory: 128Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop: ["ALL"]
    
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
    
    service:
      app:
        controller: kubernetes-event-exporter
        ports:
          metrics:
            port: *metricsPort
    
    configMaps:
      config:
        data:
          config.yaml: |
            logLevel: info
            logFormat: json
            metricsNamePrefix: event_exporter_
            
            throttle:
              afterFirst: 3
              perMinute: 10
            
            route:
              routes:
                - match:
                    - receiver: "discord"
                      kind: "ScaledObject"
                      apiVersion: "keda.sh/v1alpha1"
            
            receivers:
              - name: "discord"
                webhook:
                  endpoint: "${DISCORD_WEBHOOK_URL}"
                  headers:
                    Content-Type: "application/json"
                  layout:
                    content: |
                      **üîÑ KEDA Scaling Event**
                      {{`{{ if eq .Type "Normal" }}`}}‚úÖ{{`{{ else if eq .Type "Warning" }}`}}‚ö†Ô∏è{{`{{ else }}`}}üî¥{{`{{ end }}`}} **{{`{{ .Reason }}`}}**
                      
                      **Resource:** `{{`{{ .InvolvedObject.Namespace }}`}}/{{`{{ .InvolvedObject.Name }}`}}`
                      **Message:** {{`{{ .Message }}`}}
                      **Time:** {{`{{ .LastTimestamp }}`}}
    
    persistence:
      config:
        type: configMap
        name: kubernetes-event-exporter
        globalMounts:
          - path: /config
    
    serviceAccount:
      kubernetes-event-exporter:
        enabled: true
    
    rbac:
      roles:
        event-reader:
          enabled: true
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["events"]
              verbs: ["get", "watch", "list"]
      bindings:
        event-reader:
          enabled: true
          type: ClusterRoleBinding
          roleRef:
            identifier: event-reader
          subjects:
            - identifier: kubernetes-event-exporter
