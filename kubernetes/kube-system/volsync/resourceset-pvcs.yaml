---
# yaml-language-server: $schema=https://raw.githubusercontent.com/controlplaneio-fluxcd/flux-operator/main/config/crd/bases/fluxcd.controlplane.io_resourcesets.yaml
# ResourceSet for migrated PVCs with bootstrap capability
# Creates PVCs with dataSourceRef for automatic restore during cluster bootstrap
# hasBackup flag controls whether ReplicationDestination is created (true = restore from backup, false = empty PVC)
# App definitions are shared via the volsync-apps ResourceSetInputProvider
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: volsync-pvcs
  namespace: kube-system
spec:
  # Dependencies - wait for volsync-backups ResourceSet and CRDs
  dependsOn:
    # Wait for the backups ResourceSet (creates ExternalSecrets referenced by ReplicationDestination)
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSet
      name: volsync-backups
      namespace: kube-system
      ready: true
    # Wait for VolSync CRDs
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: replicationdestinations.volsync.backube
      ready: true
  
  # Health checks - wait for generated resources to be ready
  wait: true
  
  # Reference the consolidated InputProvider with all app configurations
  # To add a new app: add entry to the apps array in resourceset-inputprovider.yaml
  # To remove an app: delete entry from the apps array in resourceset-inputprovider.yaml
  inputsFrom:
    - name: volsync-apps

  # Loop through all apps and create both ReplicationDestination and PVC
  resourcesTemplate: |
    <<- range $app := inputs.apps >>
    ---
    # ReplicationDestination for bootstrap restore
    apiVersion: volsync.backube/v1alpha1
    kind: ReplicationDestination
    metadata:
      name: << $app.app >>-bootstrap
      namespace: default
      labels:
        kustomize.toolkit.fluxcd.io/ssa: IfNotPresent
      annotations:
        # Disable ReplicationDestination for apps without existing backups
        fluxcd.controlplane.io/reconcile: << if eq (or $app.hasBackup inputs.defaults.hasBackup) "true" >>enabled<< else >>disabled<< end >>
    spec:
      trigger:
        manual: restore-once
      kopia:
        repository: << $app.app >>-kopia-secret
        copyMethod: Snapshot
        storageClassName: ceph-block
        volumeSnapshotClassName: csi-ceph-blockpool
        accessModes: [ReadWriteOnce]
        capacity: << or $app.capacity inputs.defaults.capacity >>
        moverSecurityContext:
          runAsUser: << or $app.runAsUser inputs.defaults.runAsUser >>
          runAsGroup: << or $app.runAsUser inputs.defaults.runAsUser >>
          fsGroup: << or $app.runAsUser inputs.defaults.runAsUser >>
        sourceIdentity:
          sourceName: << $app.app >>
        cleanupTempPVC: true
        cleanupCachePVC: true
        enableFileDeletion: true
    ---
    # PVC with conditional dataSourceRef for automatic bootstrap
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: << $app.app >>-<<- or $app.pvcSuffix inputs.defaults.pvcSuffix >>
      namespace: default
    spec:
      accessModes:
        - ReadWriteOnce
      <<- if eq (or $app.hasBackup inputs.defaults.hasBackup) "true" >>
      dataSourceRef:
        apiGroup: volsync.backube
        kind: ReplicationDestination
        name: << $app.app >>-bootstrap
      <<- end >>
      storageClassName: ceph-block
      resources:
        requests:
          storage: << or $app.capacity inputs.defaults.capacity >>
    <<- end >>
