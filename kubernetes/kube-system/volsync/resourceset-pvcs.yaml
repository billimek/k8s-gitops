---
# yaml-language-server: $schema=https://raw.githubusercontent.com/controlplaneio-fluxcd/flux-operator/main/config/crd/bases/fluxcd.controlplane.io_resourcesets.yaml
# ResourceSet for migrated PVCs with bootstrap capability
# Creates PVCs with dataSourceRef for automatic restore during cluster bootstrap
# hasBackup flag controls whether ReplicationDestination is created (true = restore from backup, false = empty PVC)
# App definitions are shared via the volsync-apps ResourceSetInputProvider
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: volsync-pvcs
  namespace: kube-system
spec:
  # Dependencies - wait for volsync-backups ResourceSet and CRDs
  dependsOn:
    # Wait for the backups ResourceSet (creates ExternalSecrets referenced by ReplicationDestination)
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSet
      name: volsync-backups
      namespace: kube-system
      ready: true
    # Wait for VolSync CRDs
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: replicationdestinations.volsync.backube
      ready: true
  
  # Health checks - wait for generated resources to be ready
  wait: true
  
  # Import shared app definitions
  inputsFrom:
    - kind: ResourceSetInputProvider
      name: volsync-apps

  resources:
    # ReplicationDestination for bootstrap restore
    - apiVersion: volsync.backube/v1alpha1
      kind: ReplicationDestination
      metadata:
        name: << inputs.app >>-bootstrap
        namespace: default
        labels:
          kustomize.toolkit.fluxcd.io/ssa: IfNotPresent
        annotations:
          # Disable ReplicationDestination for apps without existing backups
          fluxcd.controlplane.io/reconcile: << if eq inputs.hasBackup "true" >>enabled<< else >>disabled<< end >>
      spec:
        trigger:
          manual: restore-once
        kopia:
          repository: << inputs.app >>-kopia-secret
          copyMethod: Snapshot
          storageClassName: ceph-block
          volumeSnapshotClassName: csi-ceph-blockpool
          accessModes: [ReadWriteOnce]
          capacity: << inputs.capacity >>
          cacheStorageClassName: ceph-block
          cacheAccessModes: [ReadWriteOnce]
          cacheCapacity: 2Gi
          moverSecurityContext:
            runAsUser: << inputs.runAsUser >>
            runAsGroup: << inputs.runAsUser >>
            fsGroup: << inputs.runAsUser >>
          sourceIdentity:
            sourceName: << inputs.app >>
          cleanupTempPVC: true
          cleanupCachePVC: true
          enableFileDeletion: true

  # PVC with conditional dataSourceRef for automatic bootstrap
  resourcesTemplate: |
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: << inputs.pvcName >>
      namespace: default
    spec:
      accessModes:
        - ReadWriteOnce
      <<- if eq inputs.hasBackup "true" >>
      dataSourceRef:
        apiGroup: volsync.backube
        kind: ReplicationDestination
        name: << inputs.app >>-bootstrap
      <<- end >>
      storageClassName: ceph-block
      resources:
        requests:
          storage: << inputs.capacity >>
