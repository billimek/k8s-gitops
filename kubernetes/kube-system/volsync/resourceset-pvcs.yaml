---
# yaml-language-server: $schema=https://raw.githubusercontent.com/controlplaneio-fluxcd/flux-operator/main/config/crd/bases/fluxcd.controlplane.io_resourcesets.yaml
# ResourceSet for migrated PVCs with bootstrap capability
# Creates PVCs with dataSourceRef for automatic restore during cluster bootstrap
# These apps have been migrated from Helm-managed to Flux-managed PVCs
# Progress: 14/21 apps migrated (67%)
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: volsync-pvcs
  namespace: kube-system
spec:
  inputs:
    # Migrated apps (14/21) - sorted alphabetically
    - app: audiobookshelf
      pvcName: audiobookshelf-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: frigate
      pvcName: frigate-config
      capacity: 10Gi
      runAsUser: "1000"
    - app: jellyseerr
      pvcName: jellyseerr-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: node-red
      pvcName: node-red-data
      capacity: 5Gi
      runAsUser: "1000"
    - app: prowlarr
      pvcName: prowlarr-config
      capacity: 5Gi
      runAsUser: "1001"
    - app: qbittorrent
      pvcName: qbittorrent-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: qui
      pvcName: qui-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: radarr
      pvcName: radarr-config
      capacity: 3Gi
      runAsUser: "1001"
    - app: sabnzbd
      pvcName: sabnzbd-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: readarr
      pvcName: readarr-config
      capacity: 6Gi
      runAsUser: "1001"
    - app: recyclarr
      pvcName: recyclarr-config
      capacity: 5Gi
      runAsUser: "1001"
    - app: sonarr
      pvcName: sonarr-config
      capacity: 2Gi
      runAsUser: "1001"
    - app: tautulli
      pvcName: tautulli-config
      capacity: 1Gi
      runAsUser: "1001"
    - app: zwave2mqtt
      pvcName: zwave2mqtt-config
      capacity: 1Gi
      runAsUser: "1001"

  resources:
    # ReplicationDestination for bootstrap restore
    - apiVersion: volsync.backube/v1alpha1
      kind: ReplicationDestination
      metadata:
        name: << inputs.app >>-bootstrap
        namespace: default
        labels:
          # Prevent Flux from resetting manual trigger values
          kustomize.toolkit.fluxcd.io/ssa: IfNotPresent
      spec:
        trigger:
          manual: restore-once
        kopia:
          repository: << inputs.app >>-kopia-secret
          copyMethod: Snapshot
          storageClassName: ceph-block
          volumeSnapshotClassName: csi-ceph-blockpool
          accessModes: [ReadWriteOnce]
          capacity: << inputs.capacity >>
          cacheStorageClassName: ceph-block
          cacheAccessModes: [ReadWriteOnce]
          cacheCapacity: 2Gi
          moverSecurityContext:
            runAsUser: << inputs.runAsUser >>
            runAsGroup: << inputs.runAsUser >>
            fsGroup: << inputs.runAsUser >>
          sourceIdentity:
            sourceName: << inputs.app >>
          cleanupTempPVC: true
          cleanupCachePVC: true
          enableFileDeletion: true

    # PVC with dataSourceRef for automatic bootstrap
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: << inputs.pvcName >>
        namespace: default
      spec:
        accessModes:
          - ReadWriteOnce
        dataSourceRef:
          apiGroup: volsync.backube
          kind: ReplicationDestination
          name: << inputs.app >>-bootstrap
        storageClassName: ceph-block
        resources:
          requests:
            storage: << inputs.capacity >>
