---
# yaml-language-server: $schema=https://raw.githubusercontent.com/controlplaneio-fluxcd/flux-operator/main/config/crd/bases/fluxcd.controlplane.io_resourcesets.yaml
# ResourceSet for VolSync backups
# Automated backups to NFS with Kopia for improved performance and deduplication
# Backup window: 4:00-7:00 AM with 9-minute staggered intervals
# Generates 42 resources (21 ExternalSecrets + 21 ReplicationSources) in default namespace
# App definitions are shared via the volsync-apps ResourceSetInputProvider
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: volsync-backups
  namespace: kube-system
spec:
  # Dependencies - wait for CRDs to be ready
  dependsOn:
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: replicationsources.volsync.backube
      ready: true
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: externalsecrets.external-secrets.io
      ready: true
  
  # Health checks - wait for generated resources to be ready
  wait: true
  
  # Reference the consolidated InputProvider with all app configurations
  # To add a new app: add entry to the apps array in resourceset-inputprovider.yaml
  # To remove an app: delete entry from the apps array in resourceset-inputprovider.yaml
  inputsFrom:
    - name: volsync-apps
  
  resourcesTemplate: |
    <<- range $app := inputs.apps >>
    ---
    # ExternalSecret for Kopia repository credentials
    apiVersion: external-secrets.io/v1
    kind: ExternalSecret
    metadata:
      name: << $app.app >>-kopia
      namespace: default
    spec:
      secretStoreRef:
        kind: ClusterSecretStore
        name: onepassword-connect
      target:
        name: << $app.app >>-kopia-secret
        creationPolicy: Owner
        template:
          engineVersion: v2
          data:
            KOPIA_FS_PATH: /repository
            KOPIA_PASSWORD: '{{ .KOPIA_PASSWORD }}'
            KOPIA_REPOSITORY: filesystem:///repository
      dataFrom:
        - extract:
            key: kopia
    ---
    # ReplicationSource for backup configuration
    apiVersion: volsync.backube/v1alpha1
    kind: ReplicationSource
    metadata:
      name: << $app.app >>
      namespace: default
    spec:
      sourcePVC: << $app.pvcName >>
      trigger:
        schedule: "<< $app.schedule >>"
      kopia:
        repository: << $app.app >>-kopia-secret
        copyMethod: Snapshot
        compression: zstd-fastest
        parallelism: 2
        accessModes: ["ReadWriteOnce"]
        volumeSnapshotClassName: csi-ceph-blockpool
        storageClassName: ceph-block
        moverSecurityContext:
          runAsUser: << $app.runAsUser >>
          runAsGroup: << $app.runAsUser >>
          fsGroup: << $app.runAsUser >>
        retain:
          hourly: 24
          daily: 10
          weekly: 4
    <<- end >>
