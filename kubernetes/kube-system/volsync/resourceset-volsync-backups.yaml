---
# yaml-language-server: $schema=https://raw.githubusercontent.com/controlplaneio-fluxcd/flux-operator/main/config/crd/bases/fluxcd.controlplane.io_resourcesets.yaml
# ResourceSet for VolSync backups
# Automated backups to NFS with Kopia for improved performance and deduplication
# Backup window: 4:00-7:00 AM with 9-minute staggered intervals
# Generates 42 resources (21 ExternalSecrets + 21 ReplicationSources) in default namespace
# App definitions are shared via the volsync-apps ResourceSetInputProvider
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: volsync-backups
  namespace: kube-system
spec:
  # Dependencies - wait for CRDs to be ready
  dependsOn:
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: replicationsources.volsync.backube
      ready: true
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: externalsecrets.external-secrets.io
      ready: true
  
  # Health checks - wait for generated resources to be ready
  wait: true
  
  # Import app-specific backup configurations from individual InputProviders
  # Each app defines its own InputProvider in its app directory
  inputsFrom:
    - kind: ResourceSetInputProvider
      name: volsync-audiobookshelf
    - kind: ResourceSetInputProvider
      name: volsync-frigate
    - kind: ResourceSetInputProvider
      name: volsync-home-assistant
    - kind: ResourceSetInputProvider
      name: volsync-jellyseerr
    - kind: ResourceSetInputProvider
      name: volsync-node-red
    - kind: ResourceSetInputProvider
      name: volsync-plex
    - kind: ResourceSetInputProvider
      name: volsync-prowlarr
    - kind: ResourceSetInputProvider
      name: volsync-qbittorrent
    - kind: ResourceSetInputProvider
      name: volsync-qui
    - kind: ResourceSetInputProvider
      name: volsync-radarr
    - kind: ResourceSetInputProvider
      name: volsync-readarr
    - kind: ResourceSetInputProvider
      name: volsync-recyclarr
    - kind: ResourceSetInputProvider
      name: volsync-sabnzbd
    - kind: ResourceSetInputProvider
      name: volsync-sonarr
    - kind: ResourceSetInputProvider
      name: volsync-tautulli
    - kind: ResourceSetInputProvider
      name: volsync-unifi
    - kind: ResourceSetInputProvider
      name: volsync-zwave2mqtt
    - kind: ResourceSetInputProvider
      name: volsync-minecraft-creative
    - kind: ResourceSetInputProvider
      name: volsync-minecraft-lobby
    - kind: ResourceSetInputProvider
      name: volsync-minecraft-survival
    - kind: ResourceSetInputProvider
      name: volsync-minecraft-survival2
  
  resources:
    # ExternalSecret for Kopia repository credentials
    - apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: << inputs.app >>-kopia
        namespace: default
      spec:
        secretStoreRef:
          kind: ClusterSecretStore
          name: onepassword-connect
        target:
          name: << inputs.app >>-kopia-secret
          creationPolicy: Owner
          template:
            engineVersion: v2
            data:
              KOPIA_FS_PATH: /repository
              KOPIA_PASSWORD: '{{ .KOPIA_PASSWORD }}'
              KOPIA_REPOSITORY: filesystem:///repository
        dataFrom:
          - extract:
              key: kopia
    # ReplicationSource for backup configuration
    - apiVersion: volsync.backube/v1alpha1
      kind: ReplicationSource
      metadata:
        name: << inputs.app >>
        namespace: default
      spec:
        sourcePVC: << inputs.pvcName >>
        trigger:
          schedule: "<< inputs.schedule >>"
        kopia:
          repository: << inputs.app >>-kopia-secret
          copyMethod: Snapshot
          compression: zstd-fastest
          parallelism: 2
          accessModes: ["ReadWriteOnce"]
          volumeSnapshotClassName: csi-ceph-blockpool
          storageClassName: ceph-block
          moverSecurityContext:
            runAsUser: << inputs.runAsUser >>
            runAsGroup: << inputs.runAsUser >>
            fsGroup: << inputs.runAsUser >>
          retain:
            hourly: 24
            daily: 10
            weekly: 4
