---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: shelfmark
  namespace: default
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  values:
    controllers:
      shelfmark:
        containers:
          app:
            image:
              repository: ghcr.io/calibrain/shelfmark-lite
              tag: dev@sha256:80637c16704b88ad0ff8560a7b7e12cdc2e1e13ce4675ea49a5b1aa3111ebb54
            command:
              - gunicorn
            args:
              - --access-logfile=-
              - --error-logfile=-
              - --worker-class=geventwebsocket.gunicorn.workers.GeventWebSocketWorker
              - --workers=1
              - -t
              - "300"
              - -b
              - 0.0.0.0:8084
              - shelfmark.main:app
            env:
              TZ: America/New_York
              FLASK_PORT: &port 8084
              AUDIOBOOK_LIBRARY_URL: https://abs.eviljungle.com
              SEARCH_MODE: universal
              
              # Download destinations
              INGEST_DIR: /media/book/import
              DESTINATION_AUDIOBOOK: /media/books/audiobooks
              
              # Metadata provider configuration
              METADATA_PROVIDER: hardcover
              METADATA_PROVIDER_AUDIOBOOK: hardcover
              HARDCOVER_ENABLED: "true"
              DEFAULT_RELEASE_SOURCE: prowlarr
              
              # Prowlarr integration
              PROWLARR_ENABLED: "true"
              PROWLARR_URL: http://prowlarr:9696
              PROWLARR_TORRENT_CLIENT: qbittorrent
              QBITTORRENT_URL: http://qbittorrent:80
              
              # File organization
              FILE_ORGANIZATION_AUDIOBOOK: organize
              TEMPLATE_AUDIOBOOK_ORGANIZE: "{Author}/{Title}/{Author} - {Title}{ (PartNumber)}"
              # HARDLINK_TORRENTS: "true"
              HARDLINK_TORRENTS_AUDIOBOOKS: "true"
              
              # Audiobookshelf integration
              CUSTOM_SCRIPT: /config/scripts/scan-audiobookshelf.sh
              AUDIOBOOKSHELF_LIBRARY_ID: 1461f532-1ee2-43f8-9f60-702176e1c3ac

            envFrom:
              - secretRef:
                  name: shelfmark-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/health
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 10
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 1Gi

    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }

    configMaps:
      scripts:
        data:
          scan-audiobookshelf.sh: |
            #!/bin/sh
            set -e
            
            # Validate required environment variables
            if [ -z "$AUDIOBOOKSHELF_TOKEN" ]; then
              echo "ERROR: AUDIOBOOKSHELF_TOKEN environment variable is not set" >&2
              exit 1
            fi
            
            if [ -z "$AUDIOBOOKSHELF_LIBRARY_ID" ]; then
              echo "ERROR: AUDIOBOOKSHELF_LIBRARY_ID environment variable is not set" >&2
              exit 1
            fi
            
            # Audiobookshelf API endpoint
            AUDIOBOOKSHELF_URL="http://audiobookshelf:80"
            SCAN_ENDPOINT="${AUDIOBOOKSHELF_URL}/api/libraries/${AUDIOBOOKSHELF_LIBRARY_ID}/scan"
            
            echo "Triggering Audiobookshelf library scan..."
            echo "Library ID: ${AUDIOBOOKSHELF_LIBRARY_ID}"
            echo "Endpoint: ${SCAN_ENDPOINT}"
            
            # Trigger the library scan
            HTTP_CODE=$(curl -s -o /tmp/abs-response.json -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${AUDIOBOOKSHELF_TOKEN}" \
              "${SCAN_ENDPOINT}")
            
            echo "Response code: ${HTTP_CODE}"
            
            # Check if the request was successful
            if [ "$HTTP_CODE" = "200" ]; then
              echo "SUCCESS: Audiobookshelf library scan triggered successfully"
              cat /tmp/abs-response.json 2>/dev/null || true
              rm -f /tmp/abs-response.json
              exit 0
            else
              echo "ERROR: Failed to trigger Audiobookshelf library scan (HTTP ${HTTP_CODE})" >&2
              cat /tmp/abs-response.json 2>/dev/null || true
              rm -f /tmp/abs-response.json
              exit 1
            fi

    service:
      app:
        controller: shelfmark
        ports:
          http:
            port: *port

    route:
      app:
        annotations:
          external-dns.alpha.kubernetes.io/internal: "true"
          external-dns.alpha.kubernetes.io/target: "10.0.6.151"
        parentRefs:
          - name: internal
            namespace: kube-system
        hostnames:
          - shelfmark.eviljungle.com

    persistence:
      config:
        existingClaim: shelfmark-config
        globalMounts:
          - path: /config
      scripts:
        type: configMap
        identifier: scripts
        defaultMode: 0755
        globalMounts:
          - path: /config/scripts
            readOnly: true
      media:
        type: nfs
        server: nas.home
        path: /mnt/tank/media
        globalMounts:
          - path: /media
      tmp:
        type: emptyDir
        globalMounts:
          - path: /tmp
            subPath: tmp
          - path: /var/log
            subPath: var-log
