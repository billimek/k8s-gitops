---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: audiobookshelf-scan
  namespace: default
spec:
  # Run every 15 minutes
  schedule: "*/15 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 300
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: scan
              image: curlimages/curl:8.11.1
              command:
                - /bin/sh
                - -c
                - |
                  echo "Triggering Audiobookshelf library scan..."
                  echo "Library ID: ${AUDIOBOOKSHELF_LIBRARY_ID}"
                  echo "Endpoint: ${AUDIOBOOKSHELF_URL}/api/libraries/${AUDIOBOOKSHELF_LIBRARY_ID}/scan"
                  
                  HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
                    -X POST \
                    -H "Authorization: Bearer ${AUDIOBOOKSHELF_TOKEN}" \
                    "${AUDIOBOOKSHELF_URL}/api/libraries/${AUDIOBOOKSHELF_LIBRARY_ID}/scan")
                  
                  echo "Response code: ${HTTP_CODE}"
                  
                  if [ "${HTTP_CODE}" = "200" ]; then
                    echo "SUCCESS: Library scan triggered"
                    cat /tmp/response.json 2>/dev/null || true
                    exit 0
                  else
                    echo "ERROR: Failed to trigger scan (HTTP ${HTTP_CODE})"
                    cat /tmp/response.json 2>/dev/null || true
                    exit 1
                  fi
              env:
                - name: AUDIOBOOKSHELF_URL
                  value: "http://audiobookshelf:80"
                - name: AUDIOBOOKSHELF_LIBRARY_ID
                  value: "1461f532-1ee2-43f8-9f60-702176e1c3ac"
                - name: AUDIOBOOKSHELF_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: shelfmark-secret
                      key: AUDIOBOOKSHELF_TOKEN
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  memory: 64Mi
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
                runAsNonRoot: true
                runAsUser: 65534
                seccompProfile:
                  type: RuntimeDefault
